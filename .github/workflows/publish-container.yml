# .github/workflows/publish-container.yml
# This workflow defines the CI/CD pipeline for building and publishing the container image.
name: Publish Container Image

# Trigger the workflow on a push event, but only for tags matching the 'v*' pattern (e.g., v1.0, v2.3.4).
on:
  push:
    tags:
      - 'v*'

# Define environment variables for the workflow.
# IMAGE_NAME is constructed using the repository owner for portability.
env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/bpip-core

jobs:
  # Define the main job for publishing the container.
  publish:
    name: Build and Publish Image
    runs-on: ubuntu-latest

    # Set permissions for the GITHUB_TOKEN.
    # 'packages: write' is required to push images to GitHub Container Registry (ghcr.io).
    # 'contents: read' is required to check out the repository code.
    permissions:
      packages: write
      contents: read

    steps:
      # Step 1: Check out the repository code.
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Log in to the GitHub Container Registry.
      # Uses the GITHUB_TOKEN for authentication, which is secure and automatically available.
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Step 3: Extract metadata (tags and labels) for the Docker image.
      # This action automatically creates tags based on the Git event.
      # For a 'v1.2.3' tag, it will generate image tags '1.2.3' and 'latest'.
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      # Step 4: Build the Docker image and push it to the registry.
      # Uses the metadata from the previous step to tag the image appropriately.
      # 'push: true' ensures the image is uploaded to the registry.
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
